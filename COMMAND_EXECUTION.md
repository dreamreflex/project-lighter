# 命令执行机制与权限处理说明

## 底层调用命令的原理

### 1. 执行架构

项目使用 **Node.js 的 `child_process.spawn()` API** 来执行命令，具体流程如下：

```
用户界面 (renderer.js)
    ↓
IPC 通信 (preload.js)
    ↓
主进程 (main.js)
    ↓
Node.js child_process.spawn()
    ↓
启动 PowerShell 进程 (powershell.exe)
    ↓
执行用户配置的命令
    ↓
实时捕获 stdout/stderr 输出
    ↓
通过 IPC 返回前端显示
```

### 2. 核心技术实现

**代码位置**: `main.js` 的 `startProject()` 函数

**关键技术点**:

1. **进程启动**:
   ```javascript
   const childProcess = spawn('powershell.exe', args, {
     cwd: workingDir,
     shell: false,
     stdio: ['pipe', 'pipe', 'pipe']  // stdin, stdout, stderr
   });
   ```

2. **命令组合**:
   - 多条命令使用条件执行：`command1; if ($?) { command2 }`
   - 前一个命令成功后才执行下一个
   - 在同一个 PowerShell 会话中顺序执行

3. **输出捕获**:
   - `stdout.on('data')` - 捕获标准输出（正常信息）
   - `stderr.on('data')` - 捕获错误输出（错误信息）
   - 实时流式处理，支持大量输出

4. **编码处理**:
   - 自动处理 UTF-8 编码
   - 支持不完整的 UTF-8 字符序列
   - 正确处理中文、特殊字符等

5. **IPC 通信**:
   - 主进程通过 `webContents.send()` 发送输出
   - 渲染进程通过 IPC 监听器接收
   - 实时更新前端界面

### 3. 错误处理机制

- **进程错误** (`childProcess.on('error')`):
  - 进程启动失败、找不到命令等
  - 会显示错误提示

- **进程退出** (`childProcess.on('exit')`):
  - 正常退出或异常退出
  - 记录退出码 (code)
  - 分析输出内容检测权限问题

- **输出错误** (stderr):
  - 命令执行错误信息
  - 实时显示在控制台

## 权限处理

### 当前行为

**如果项目需要管理员权限才能运行：**

#### **不会崩溃**
- 应用本身不会崩溃
- 只是 PowerShell 进程执行失败
- 应用继续正常运行

#### **会显示错误信息**
- PowerShell 会输出权限错误到 stderr
- 错误信息显示在项目的输出控制台
- 前端会显示错误提示

#### **自动检测权限错误**
- 系统会分析输出内容
- 自动检测常见的权限错误关键词：
  - "Access is denied"
  - "拒绝访问"
  - "Permission denied"
  - "需要管理员权限"
  - "administrator"
  - 等等

#### **友好的权限提示**
- 检测到权限错误时，会显示黄色提示框
- 提示用户需要以管理员身份运行
- 显示解决方法

### 错误显示示例

当命令需要管理员权限时：

**控制台输出**:
```
[错误: 拒绝访问]
Access is denied
需要管理员权限才能执行此操作
```

**权限提示框** (黄色):
```
权限提示：
此命令可能需要管理员权限。请尝试以管理员身份运行此应用。
解决方法：右键点击应用图标 → 选择"以管理员身份运行"
```

**错误提示** (红色):
```
项目需要管理员权限才能运行。请以管理员身份运行此应用后重试。
```

### 退出码说明

- **退出码 0**: 命令成功执行
- **退出码非零**: 命令执行失败
  - 可能是权限错误
  - 可能是命令本身错误
  - 可能是其他运行时错误

### 权限提升

**当前限制**:
- 应用不会自动弹出 UAC 提示
- 不会自动请求管理员权限
- 会提示用户需要管理员权限

**解决方法**:
1. 右键点击应用图标
2. 选择 "以管理员身份运行"
3. 重新启动项目

## 技术细节

### 命令执行方式

使用 PowerShell 作为命令解释器：
- 优点：功能强大，支持复杂命令
- 支持：变量、条件、循环等 PowerShell 特性
- 编码：自动设置 UTF-8 编码环境

### 进程管理

- 每个项目对应一个 PowerShell 进程
- 进程 ID 存储在 `runningProcesses` Map 中
- 停止项目时，会终止整个进程树

### 输出缓冲

- 使用缓冲区处理不完整的 UTF-8 字符
- 防止跨数据块的字符被截断
- 确保正确显示多字节字符

## 改进建议

如果需要自动权限提升功能，可以考虑：

1. **检测 UAC 需求**: 分析命令或使用 Windows API 检测
2. **使用 elevate.exe**: Windows 上可以使用工具请求权限提升
3. **在 manifest 中声明**: 应用可以声明需要管理员权限（但会在启动时弹出 UAC）

目前的设计是：**让用户控制何时需要管理员权限**，而不是自动提升，这样更安全。

